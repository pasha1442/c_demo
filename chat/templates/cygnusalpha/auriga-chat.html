{% load static  %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auriga Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        .gvi_main_container {
            background-size: 400px;
            height: 100vh;
            text-align: center;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            display: flex;
            flex-flow: column;
        }
        
        .gvi_header__backBtn {
            display: none;
        }
        
        .gvi_header {
            padding: 30px 0;
        }
        
        .gvi_header__logo {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gvi_header__logo img {
            max-width: 120px;
            cursor: pointer;
        }
        
        .gvi_header__logo h2 {
            font-size: 22px;
            color: #a1cdf1;
        }
        
        .gvi_chat_search_container {
            background: linear-gradient(180deg, #91c4db, #19ade7);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 10px;
        }
        
        .gvi_search {
            background: #fff;
            display: flex;
            align-items: center;
            border-radius: 50px;
            padding: 10px 15px;
            max-width: 400px;
            margin: 0 auto;
            border: 2px solid #D9D9D9;
        }
        
        .gvi_search input {
            border: 0;
            height: 36px;
            font-size: 16px;
            width: 400px;
            flex: 1;
            color: #222226;
        }
        
        .gvi_search input:focus-visible {
            outline: 0;
        }
        
        .gvi_search button {
            all: unset;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .gvi_chat_container {
            flex: 1;
            max-width: 600px;
            margin: 10px auto 0;
            width: 100%;
            padding-bottom: 100px;
        }
        
        .chat-message {
            margin-bottom: 10px;
            border-radius: 12px;
            padding: 10px;
            line-height: 1.4;
            font-size: 15px;
            color: #000000;
            font-weight: 500;
            width: fit-content;
            background: #b8e0ec;
            max-width: 75%;
            word-wrap: break-word;
            text-align: left;
        }
        
        .chat-message.user {
            margin-left: auto;
            background: #edf1f1;
            text-align: right;
        }
        
        .message-content :is(ol,ul) {
            list-style-position: inside;
        }
        /* bouncing dots css start */
        .bouncing-dots {
            display: inline-block;
            position: relative;
            width: 40px;
            height: 20px;
        }
        
        .bouncing-dots div {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #026956f5;;
            top: 8px;
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        
        .bouncing-dots div:nth-child(1) {
            left: 4px;
            animation: bouncing-dots1 0.6s infinite;
        }
        
        .bouncing-dots div:nth-child(2) {
            left: 4px;
            animation: bouncing-dots2 0.6s infinite;
        }
        
        .bouncing-dots div:nth-child(3) {
            left: 16px;
            animation: bouncing-dots2 0.6s infinite;
        }
        
        .bouncing-dots div:nth-child(4) {
            left: 28px;
            animation: bouncing-dots3 0.6s infinite;
        }
        
        @keyframes bouncing-dots1 {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        
        @keyframes bouncing-dots2 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(12px, 0); }
        }
        
        @keyframes bouncing-dots3 {
            0% { transform: scale(1); }
            100% { transform: scale(0); }
        }
        /* bouncing dots css end */
        
        .gvi_up_arrow {
            position: fixed;
            bottom: 120px;
            right: 20px;
            cursor: pointer;
            display: none;
        }
        .gvi_up_arrow img {
            width: 60px;
        }

        @media (max-width: 767px) {
            .gvi_main_container {
                padding-inline: 10px;
                background-size: 350px;
            }
            .gvi_header {
                padding: 15px 0;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .gvi_header__logo h2 {
                font-size: 18px;
            }
            .gvi_header__backBtn {
                display: block;
                position: absolute;
                left: 10px;
                cursor: pointer;
            }
            .chat-message {
                font-size: 14px;
                line-height: 1.3;
            }
            .gvi_up_arrow img {
                width: 40px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="gvi_main_container">
        <div class="gvi_header">
            <div class="gvi_header__backBtn" id="gvi_header__backBtn"><img src="https://cdn.kindlife.in/images/ui_icon/backBtn-black.svg"> </div>
            <div class="gvi_header__logo" id="gvi_header__logo">
                <figure><img id="gvi_header__logo_img" src="{% static 'admin/img/client-logo/auriga-it.webp' %}"></figure>
            </div>
        </div>

        <div class="gvi_chat_container">
            <div class="chat-body" id="chatBody">
                <!-- Chat messages will be appended here -->
            </div>
        </div>
        

        <div class="gvi_chat_search_container">
            <div class="gvi_search">
                <input type="text" id="chatInput" class="chat-input" placeholder="Hey there! ask your queries...">
                <button id="chatSend" class="chat-send"><img src="https://cdn.kindlife.in/images/ui_icon/gvi-rigthArrow-GrdBtn.png"></button>
            </div>
        </div>
        <div class="gvi_up_arrow" id="gvi_up_arrow" onclick="topFunction()"><img src="https://cdn.kindlife.in/images/ui_icon/upArrow-CircleBtn.svg"></div>
    </div>

<script>
    const mybutton = document.getElementById("gvi_up_arrow");
    window.onscroll = function() {scrollFunction()};
    function scrollFunction() {
        if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
            mybutton.style.display = "block";
        } else {
            mybutton.style.display = "none";
        }
    }
    function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    }
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    window.onload = function(){
        session_id = generateUUID();
        const userInput = localStorage.getItem('userInput');
        if(userInput){
            const chatInput = document.getElementById('chatInput');
            chatInput.value = userInput;
            document.getElementById('chatSend').click();
            localStorage.removeItem('userInput');
        }
    }
    session_id = generateUUID();
    document.getElementById('chatSend').addEventListener('click', function() {
        const chatInput = document.getElementById('chatInput');
        const chatBody = document.getElementById('chatBody');
        const messageText = chatInput.value.trim();

        if (messageText === '') return;

        // Display user's message
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'chat-message user';
        userMessageDiv.innerHTML = `<div class="message-content">${messageText}</div>`;
        chatBody.appendChild(userMessageDiv);

        chatInput.value = '';
        chatBody.scrollTop = chatBody.scrollHeight;

        // Display bouncing dots
        const botMessageDiv = document.createElement('div');
        botMessageDiv.className = 'chat-message bot';
        botMessageDiv.innerHTML = `<div class="message-content"><div class="bouncing-dots"><div></div><div></div><div></div><div></div></div></div>`;
        chatBody.appendChild(botMessageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;

        fetch('/api/v1/api-controller/invoke-service/auriga-chat/', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer CA-9544ea96-b1af-4446-9cef-cdde6027444GH',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mobile: '0000000000',
                text: messageText,
                session_id: session_id
            })
        })
        .then(async (response) => {
            if (!response.body) {
                throw new Error('Readable stream not supported.');
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
        
            let result = "";
            let done = false;
        
            while (!done) {
                // Read the next chunk from the response
                const { value, done: streamDone } = await reader.read();
                done = streamDone;
                
                if (value) {
                    // Decode the chunk to text and accumulate the result
                    result += decoder.decode(value, { stream: true });
                    // Here you can handle each chunk of data and append it to the chat body
                    const formatted_giva_message = marked.parse(result);
                    botMessageDiv.innerHTML = `<div class="message-content">${formatted_giva_message}</div>`;
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            }
        
            // Handle any final data when the stream is done
            if (done) {
                const finalMessage = marked.parse(result);
                botMessageDiv.innerHTML = `<div class="message-content">${finalMessage}</div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        })
        .catch(error => {
            console.error("Error in streaming response:", error);
        });

        // Call the API to get the chatbot response
        /*
        fetch('/api/v1/api-controller/invoke-service/gvi-chat/', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer kl-9544ea96-b1af-4446-9cef-cdde602733a3',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mobile: '0000000000',
                text: messageText,
                session_id: session_id
            })
        })
        .then(response => response.json())
        .then(data => {
            // Remove bouncing dots
            const gvi_message = data.data;
            const formatted_giva_message = marked.parse(gvi_message);
            botMessageDiv.innerHTML = `<div class="message-content">${formatted_giva_message}</div>`;
            chatBody.scrollTop = chatBody.scrollHeight;
        })
        .catch(error => {
            // Remove bouncing dots and show error message
            console.log("Error: ", error)
            botMessageDiv.innerHTML = `<div class="message-content">An error occurred</div>`;
            chatBody.scrollTop = chatBody.scrollHeight;
        });
        */
    });
    document.getElementById('chatInput').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('chatSend').click();
        }
    });
    document.getElementById('gvi_header__backBtn').addEventListener('click', function() {
        const basePath = window.location.origin + '/gvi/home/';
        window.location.href = basePath;
    });
    document.getElementById('gvi_header__logo_img').addEventListener('click', function() {
        const basePath = window.location.origin + '/gvi/home/';
        window.location.href = basePath;
    });
</script>

</body>
</html>